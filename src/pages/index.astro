---
import Layout from '../layouts/Layout.astro';
import AuthButton from '../components/AuthButton';
import SearchApp from '../components/SearchApp';
import { getTokenFromCookies, getRefreshTokenFromCookies } from '../lib/auth';

const cookieHeader = Astro.request.headers.get('cookie');
const accessToken = getTokenFromCookies(cookieHeader);
const refreshToken = getRefreshTokenFromCookies(cookieHeader);
const isAuthenticated = !!(accessToken || refreshToken);

const error = Astro.url.searchParams.get('error');
const initialQuery = Astro.url.searchParams.get('q') || '';
const initialUrl = Astro.url.searchParams.get('url') || '';
---

<Layout title="Spillover">
  <div class="min-h-screen flex flex-col">
    <!-- Header -->
    <header class="border-b border-spotify-gray/20">
      <div class="max-w-4xl mx-auto px-4 py-4 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <svg class="w-8 h-8" viewBox="0 0 32 32" fill="none">
            <circle cx="16" cy="16" r="15" stroke="url(#spillover-gradient)" stroke-width="2"/>
            <path d="M10 20C10 20 12 12 16 12C20 12 22 20 22 20" stroke="url(#spillover-gradient)" stroke-width="2.5" stroke-linecap="round"/>
            <circle cx="10" cy="20" r="3" fill="url(#spillover-gradient)"/>
            <circle cx="22" cy="20" r="3" fill="url(#spillover-gradient)"/>
            <path d="M16 8V12" stroke="url(#spillover-gradient)" stroke-width="2" stroke-linecap="round"/>
            <path d="M13 6L16 8L19 6" stroke="url(#spillover-gradient)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <defs>
              <linearGradient id="spillover-gradient" x1="0" y1="0" x2="32" y2="32">
                <stop offset="0%" stop-color="#22c55e"/>
                <stop offset="100%" stop-color="#16a34a"/>
              </linearGradient>
            </defs>
          </svg>
          <h1 class="text-xl font-bold">Spillover</h1>
        </div>
        <AuthButton client:load isAuthenticated={isAuthenticated} />
      </div>
    </header>

    <!-- Main Content -->
    <main class="flex-grow">
      {error && (
        <div class="max-w-4xl mx-auto px-4 py-4">
          <div class="bg-red-500/10 border border-red-500/30 rounded-lg p-4 text-red-400">
            <p>
              {error === 'state_mismatch' && 'Authentication failed: state mismatch. Please try again.'}
              {error === 'no_code' && 'Authentication failed: no authorization code received.'}
              {error === 'token_exchange_failed' && 'Authentication failed: could not exchange token.'}
              {error === 'access_denied' && 'Authentication was denied. Please try again.'}
              {!['state_mismatch', 'no_code', 'token_exchange_failed', 'access_denied'].includes(error) && `Authentication error: ${error}`}
            </p>
          </div>
        </div>
      )}

      {isAuthenticated ? (
        <div class="max-w-4xl mx-auto px-4 py-8">
          <SearchApp client:load initialQuery={initialQuery || initialUrl} />
        </div>
      ) : (
        <div class="max-w-2xl mx-auto px-4 py-16 text-center">
          <h2 class="text-4xl font-bold mb-4">Save Tracks to Spotify</h2>
          <p class="text-xl text-spotify-lightgray mb-8">
            Listening on another platform? Quickly search and save tracks to your Spotify library without switching apps.
          </p>

          <AuthButton client:load isAuthenticated={false} />

          <div class="mt-16 grid gap-6 md:grid-cols-3 text-left">
            <div class="bg-spotify-gray/10 rounded-lg p-6">
              <div class="w-10 h-10 bg-spotify-green/20 rounded-lg flex items-center justify-center mb-4">
                <svg class="w-5 h-5 text-spotify-green" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                </svg>
              </div>
              <h3 class="font-semibold mb-2">Quick Search</h3>
              <p class="text-sm text-spotify-lightgray">Search for tracks as you type with instant results from Spotify's catalog.</p>
            </div>

            <div class="bg-spotify-gray/10 rounded-lg p-6">
              <div class="w-10 h-10 bg-spotify-green/20 rounded-lg flex items-center justify-center mb-4">
                <svg class="w-5 h-5 text-spotify-green" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
                </svg>
              </div>
              <h3 class="font-semibold mb-2">One-Click Like</h3>
              <p class="text-sm text-spotify-lightgray">Save tracks to your Liked Songs with a single click.</p>
            </div>

            <div class="bg-spotify-gray/10 rounded-lg p-6">
              <div class="w-10 h-10 bg-spotify-green/20 rounded-lg flex items-center justify-center mb-4">
                <svg class="w-5 h-5 text-spotify-green" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                </svg>
              </div>
              <h3 class="font-semibold mb-2">Add to Playlists</h3>
              <p class="text-sm text-spotify-lightgray">Add tracks to any of your existing Spotify playlists.</p>
            </div>
          </div>
        </div>
      )}
    </main>

    <!-- Footer -->
    <footer class="border-t border-spotify-gray/20">
      <div class="max-w-4xl mx-auto px-4 py-4 flex items-center justify-between text-sm text-spotify-lightgray">
        <p>Not affiliated with Spotify. Built for personal use.</p>
        <div class="flex items-center gap-4">
          <a href="/privacy" class="hover:text-white transition-colors">
            Privacy
          </a>
          <a href="/extension" class="flex items-center gap-2 hover:text-white transition-colors">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01" />
            </svg>
            Extension
          </a>
        </div>
      </div>
    </footer>
  </div>
</Layout>
